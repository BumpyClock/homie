# Learnings

- 2026-02-01: Initialized.
- 2026-02-01: Added backend PRD in prd.md from plan.md; co-located gateway+node, Tailscale auth, Codex integration, persistence.
- 2026-02-01: Added web PRD in web.prd; terminal-only web client, xterm.js, tabs/keybar, themes, saved targets.
- 2026-02-01: Added RN PRD in rn-mobile.prd; terminal-only, WebView xterm.js, tabs, target management.
- 2026-01-31: US-002 WS server: axum 0.8 + tokio-tungstenite. TailscaleWhois trait needs object-safe (Pin<Box<dyn Future>>) for Arc<dyn> in axum state. ConnectInfo requires into_make_service_with_connect_info; use middleware to inject RemoteIp extension. tokio::time::sleep_until in select! for idle timeout (not post-loop check). tokio-tungstenite 0.26 uses Utf8Bytes not String.
- 2026-01-31: US-003 Terminal service: portable-pty 0.9 returns anyhow::Error from MasterPty methods (resize, try_clone_reader) — map to String rather than pulling anyhow dep. Reader thread uses std::thread (blocking I/O) + AtomicBool shutdown flag + oneshot channel bridge. Output forwarding via mpsc → tokio task → WsMessage::Binary. TerminalService is per-connection (not shared), lives in message loop scope — Drop triggers shutdown_all. Reap interval (2s) polls try_wait for exit events.
- 2026-01-31: US-004 Router + subscriptions: ServiceHandler trait uses `Pin<Box<dyn Future + Send + '_>>` return for handle_request (can't use async_trait without the dep, and object-safety requires boxing). MessageRouter extracts namespace from first dotted segment of method name. SubscriptionManager uses three indexes (exact, prefix, catch-all) for O(1)-ish topic matching. Backpressure via try_send on bounded mpsc channel — drops PTY frames when client is slow rather than blocking. Events are only delivered to clients with matching subscriptions (no more broadcast). ServiceRegistry is Clone (shared via AppState) and advertises capabilities in ServerHello.
- 2026-01-31: US-005 Agent service (Codex integration): CodexProcess spawns `codex app-server` with stdin/stdout pipes, JSONL protocol. Reader loop uses tokio::select! to interleave pending-waiter registration with line reads. `method` param in handle_request must be cloned to String before moving into the async block (lifetime issue). Event forwarder maps Codex notification methods to Homie topics via static lookup. Approval requests from Codex carry an integer `id` — forwarded as `codex_request_id` in event params, client responds via `agent.chat.approval.respond` RPC. AgentService lazily spawns CodexProcess on first `agent.chat.create`. outbound_tx must be cloned before passing to both TerminalService and AgentService in connection.rs.
- 2026-01-31: US-006 Persistence layer: rusqlite 0.38 (bundled) for sqlite storage. `Store` trait (Send+Sync+'static) with `&self` methods — Mutex<Connection> for interior mutability. rusqlite doesn't impl ToSql/FromSql for u64 — cast to i64 at boundary. Clippy flags `from_str` method name as conflicting with std trait — renamed to `from_label`. Store passed as Arc<dyn Store> through AppState → run_connection → services. build_router calls mark_all_inactive on startup to flag stale sessions. Services persist metadata on create/exit/disconnect. New RPCs: `terminal.session.list`, `agent.chat.list`.
- 2026-02-01: Added authz roles/scopes with per-method checks; introduced outbound event filtering; added presence registry/service and stub jobs/pairing/notifications; added homie-gateway binary with env config; event pointer increments on Codex events.
- 2026-02-01: Implemented in-memory jobs/pairing/notifications services with registries and basic RPCs; notifications.send emits notifications.sent event.
- 2026-02-01: Jobs/pairings/notifications now persisted in sqlite with retention (jobs: days+max; pairings: TTL+retention; notifications: subs+events retention). jobs.start spec stored as JSON; notifications.send records event + emits notifications.sent.
- 2026-02-01: Web client must use WS envelope `{type:"request"}`/`{type:"response"}`, connect via `/ws`, and call `terminal.session.attach` before rendering; session status uses lowercase strings.
- 2026-02-01: Added `HOMIE_ALLOW_LAN=1` to allow non-loopback private IP connections (LAN) without Tailscale Serve.
- 2026-02-01: Terminal sessions now live in a shared registry; disconnect detaches but does not kill PTY, enabling reattach after refresh.
- 2026-02-01: Reattach replays buffered PTY output (size-limited, `HOMIE_HISTORY_BYTES`) so terminals restore on reconnect.
- 2026-02-01: Added terminal session names (sqlite column + RPC rename) and UI labels for renamed/tmux sessions, with tab/card display driven by session-utils helpers.
- 2026-02-02: Added chat settings (model/effort/permission/agent mode) UI + token usage events; new chat model/collaboration list RPCs; approval events include fallback request id.
- 2026-02-02: Persisted chat settings in sqlite; chat.list/thread.read return settings; chat.message.send writes settings; added approval logging.
- 2026-02-02: Added chat.settings.update + chat.files.search; file search reads attached folder from chat settings; UI exposes / skills and @ file mentions with folder attachment.
- 2026-02-02: Chat inline menu now caret-anchored with textarea mirror helper; extracted chat thread list/header/menu components; fixed @ mention regex.
- 2026-02-02: File search now expands ~ and resolves relative paths for attached folder before scanning.
- 2026-02-02: Added chat file search debug logs in gateway + browser to diagnose missing @ results.
- 2026-02-02: chat.files.search now accepts base_path/basePath override (UI passes attached folder) to avoid missing server settings.
- 2026-02-02: Composer now renders inline mention badges for [file:...] tokens via overlayed textarea (craft-like UX).
- 2026-02-02: Caret visibility fixed by using --color-foreground for caret-color on composer textarea.
- 2026-02-02: Chat rendering now uses Craft-style turns (user bubble + assistant card with collapsible activities + markdown).
- 2026-02-02: Chat scroll now sticks to bottom when user is at bottom; detaches on scroll up.
- 2026-02-02: Added chat UX refinements: gradient mask, fade-in, load-more on scroll-up, tool intent chips, inline mention badges in markdown.
- 2026-02-02: Collapsed chat steps now surface last-step + reasoning previews with animated typing dots; approvals stay visible outside the accordion.
- 2026-02-02: Added OpenClaw-inspired next steps to phase1 plan (system prompt assembly, memory search, compaction, hooks, heartbeats).
- 2026-02-02: Added plan block for replacing Codex CLI app-server with embedded loop + OAuth retention and future provider adapters.
- 2026-02-02: Reorganized repo layout under src/ (core, gateway, infra) and moved roci submodule to src/infra.
- 2026-02-02: Windows PTY can emit tiny chunks; if early bytes are dropped (e.g. lone ESC), escape sequences degrade (literal `[6n`) and shells can block waiting for a DSR response. Fix by buffering PTY bytes until the UI listener is ready and ensuring attach can replay startup history (avoid auto-attach on start).
- 2026-02-02: More robust: delay `terminal.session.attach` until the terminal tab registers its data listener; then attach triggers history replay + live streaming after the UI is ready.
- 2026-02-02: Dev React StrictMode can mount/unmount terminal tabs quickly; if client prevents re-attaching, startup history replay (incl. `ESC[6n`) may be delivered only during the throwaway mount, leaving pwsh waiting forever. Fix: allow `terminal.session.attach` (+ replay) on every tab listener mount.
- 2026-02-02: Windows: treat `cmd.exe /d` passed as a single string as `cmd.exe` + arg `/d` (avoid CreateProcessW path error).
- 2026-02-02: pwsh/PSReadLine emits DSR query `ESC[6n` on startup; ghostty-web doesn't reliably reply. Fix: detect `ESC[6n` in PTY output and inject a cursor report reply `ESC[1;1R` from client to unblock startup (also strip query so preview doesn't show `[6n`).
- 2026-02-02: Added cross-platform homie home resolution via `directories` crate + `HOMIE_HOME` override; used for codex app-server dir and `~` expansion.
- 2026-02-03: Added Homie config loader + execpolicy parser/matcher (token glob + shorthand), with debug raw event gating and cross-platform home resolution helpers.
- 2026-02-03: Persist raw provider events in sqlite when debug is enabled; keep last 10 runs via chat_runs/chat_raw_events retention.
- 2026-02-03: Added roci auth scaffolding (device-code sessions, file token store, provider helpers) in submodule.
