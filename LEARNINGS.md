# Learnings

- 2026-02-01: Initialized.
- 2026-02-01: Added backend PRD in prd.md from plan.md; co-located gateway+node, Tailscale auth, Codex integration, persistence.
- 2026-02-01: Added web PRD in web.prd; terminal-only web client, xterm.js, tabs/keybar, themes, saved targets.
- 2026-02-01: Added RN PRD in rn-mobile.prd; terminal-only, WebView xterm.js, tabs, target management.
- 2026-01-31: US-002 WS server: axum 0.8 + tokio-tungstenite. TailscaleWhois trait needs object-safe (Pin<Box<dyn Future>>) for Arc<dyn> in axum state. ConnectInfo requires into_make_service_with_connect_info; use middleware to inject RemoteIp extension. tokio::time::sleep_until in select! for idle timeout (not post-loop check). tokio-tungstenite 0.26 uses Utf8Bytes not String.
- 2026-01-31: US-003 Terminal service: portable-pty 0.9 returns anyhow::Error from MasterPty methods (resize, try_clone_reader) — map to String rather than pulling anyhow dep. Reader thread uses std::thread (blocking I/O) + AtomicBool shutdown flag + oneshot channel bridge. Output forwarding via mpsc → tokio task → WsMessage::Binary. TerminalService is per-connection (not shared), lives in message loop scope — Drop triggers shutdown_all. Reap interval (2s) polls try_wait for exit events.
- 2026-01-31: US-004 Router + subscriptions: ServiceHandler trait uses `Pin<Box<dyn Future + Send + '_>>` return for handle_request (can't use async_trait without the dep, and object-safety requires boxing). MessageRouter extracts namespace from first dotted segment of method name. SubscriptionManager uses three indexes (exact, prefix, catch-all) for O(1)-ish topic matching. Backpressure via try_send on bounded mpsc channel — drops PTY frames when client is slow rather than blocking. Events are only delivered to clients with matching subscriptions (no more broadcast). ServiceRegistry is Clone (shared via AppState) and advertises capabilities in ServerHello.
- 2026-01-31: US-005 Agent service (Codex integration): CodexProcess spawns `codex app-server` with stdin/stdout pipes, JSONL protocol. Reader loop uses tokio::select! to interleave pending-waiter registration with line reads. `method` param in handle_request must be cloned to String before moving into the async block (lifetime issue). Event forwarder maps Codex notification methods to Homie topics via static lookup. Approval requests from Codex carry an integer `id` — forwarded as `codex_request_id` in event params, client responds via `agent.chat.approval.respond` RPC. AgentService lazily spawns CodexProcess on first `agent.chat.create`. outbound_tx must be cloned before passing to both TerminalService and AgentService in connection.rs.
- 2026-01-31: US-006 Persistence layer: rusqlite 0.38 (bundled) for sqlite storage. `Store` trait (Send+Sync+'static) with `&self` methods — Mutex<Connection> for interior mutability. rusqlite doesn't impl ToSql/FromSql for u64 — cast to i64 at boundary. Clippy flags `from_str` method name as conflicting with std trait — renamed to `from_label`. Store passed as Arc<dyn Store> through AppState → run_connection → services. build_router calls mark_all_inactive on startup to flag stale sessions. Services persist metadata on create/exit/disconnect. New RPCs: `terminal.session.list`, `agent.chat.list`.
- 2026-02-01: Added authz roles/scopes with per-method checks; introduced outbound event filtering; added presence registry/service and stub jobs/pairing/notifications; added homie-gateway binary with env config; event pointer increments on Codex events.
- 2026-02-01: Implemented in-memory jobs/pairing/notifications services with registries and basic RPCs; notifications.send emits notifications.sent event.
- 2026-02-01: Jobs/pairings/notifications now persisted in sqlite with retention (jobs: days+max; pairings: TTL+retention; notifications: subs+events retention). jobs.start spec stored as JSON; notifications.send records event + emits notifications.sent.
- 2026-02-01: Web client must use WS envelope `{type:"request"}`/`{type:"response"}`, connect via `/ws`, and call `terminal.session.attach` before rendering; session status uses lowercase strings.
- 2026-02-01: Added `HOMIE_ALLOW_LAN=1` to allow non-loopback private IP connections (LAN) without Tailscale Serve.
- 2026-02-01: Terminal sessions now live in a shared registry; disconnect detaches but does not kill PTY, enabling reattach after refresh.
- 2026-02-01: Reattach replays buffered PTY output (size-limited, `HOMIE_HISTORY_BYTES`) so terminals restore on reconnect.
- 2026-02-01: Added terminal session names (sqlite column + RPC rename) and UI labels for renamed/tmux sessions, with tab/card display driven by session-utils helpers.
- 2026-02-02: Added chat settings (model/effort/permission/agent mode) UI + token usage events; new chat model/collaboration list RPCs; approval events include fallback request id.
- 2026-02-02: Persisted chat settings in sqlite; chat.list/thread.read return settings; chat.message.send writes settings; added approval logging.
- 2026-02-02: Added chat.settings.update + chat.files.search; file search reads attached folder from chat settings; UI exposes / skills and @ file mentions with folder attachment.
- 2026-02-02: Chat inline menu now caret-anchored with textarea mirror helper; extracted chat thread list/header/menu components; fixed @ mention regex.
- 2026-02-02: File search now expands ~ and resolves relative paths for attached folder before scanning.
- 2026-02-02: Added chat file search debug logs in gateway + browser to diagnose missing @ results.
- 2026-02-02: chat.files.search now accepts base_path/basePath override (UI passes attached folder) to avoid missing server settings.
- 2026-02-02: Composer now renders inline mention badges for [file:...] tokens via overlayed textarea (craft-like UX).
- 2026-02-02: Caret visibility fixed by using --color-foreground for caret-color on composer textarea.
- 2026-02-02: Chat rendering now uses Craft-style turns (user bubble + assistant card with collapsible activities + markdown).
- 2026-02-02: Chat scroll now sticks to bottom when user is at bottom; detaches on scroll up.
- 2026-02-02: Added chat UX refinements: gradient mask, fade-in, load-more on scroll-up, tool intent chips, inline mention badges in markdown.
- 2026-02-02: Collapsed chat steps now surface last-step + reasoning previews with animated typing dots; approvals stay visible outside the accordion.
- 2026-02-02: Added OpenClaw-inspired next steps to phase1 plan (system prompt assembly, memory search, compaction, hooks, heartbeats).
- 2026-02-02: Added plan block for replacing Codex CLI app-server with embedded loop + OAuth retention and future provider adapters.
- 2026-02-02: Reorganized repo layout under src/ (core, gateway, infra) and moved roci submodule to src/infra.
- 2026-02-02: Windows PTY can emit tiny chunks; if early bytes are dropped (e.g. lone ESC), escape sequences degrade (literal `[6n`) and shells can block waiting for a DSR response. Fix by buffering PTY bytes until the UI listener is ready and ensuring attach can replay startup history (avoid auto-attach on start).
- 2026-02-02: More robust: delay `terminal.session.attach` until the terminal tab registers its data listener; then attach triggers history replay + live streaming after the UI is ready.
- 2026-02-02: Dev React StrictMode can mount/unmount terminal tabs quickly; if client prevents re-attaching, startup history replay (incl. `ESC[6n`) may be delivered only during the throwaway mount, leaving pwsh waiting forever. Fix: allow `terminal.session.attach` (+ replay) on every tab listener mount.
- 2026-02-02: Windows: treat `cmd.exe /d` passed as a single string as `cmd.exe` + arg `/d` (avoid CreateProcessW path error).
- 2026-02-02: pwsh/PSReadLine emits DSR query `ESC[6n` on startup; ghostty-web doesn't reliably reply. Fix: detect `ESC[6n` in PTY output and inject a cursor report reply `ESC[1;1R` from client to unblock startup (also strip query so preview doesn't show `[6n`).
- 2026-02-02: Added cross-platform homie home resolution via `directories` crate + `HOMIE_HOME` override; used for codex app-server dir and `~` expansion.
- 2026-02-03: Added Homie config loader + execpolicy parser/matcher (token glob + shorthand), with debug raw event gating and cross-platform home resolution helpers.
- 2026-02-03: Persist raw provider events in sqlite when debug is enabled; keep last 10 runs via chat_runs/chat_raw_events retention.
- 2026-02-03: Added roci auth scaffolding (device-code sessions, file token store, provider helpers) in submodule.
- 2026-02-03: Added chat.account.list for provider login status using roci token store.
- 2026-02-03: chat.account.list now auto-imports Codex/Claude CLI creds into Homie token store; Codex import respects CODEX_HOME.
- 2026-02-03: Added roci agent_loop scaffolding (run/events/approvals) behind feature gate; added chat.account.login.start/poll device-code RPCs in gateway.
- 2026-02-03: Added Roci tool set in homie-core (read/ls/find/grep/apply_patch/exec/process) with background process registry; exec/process approvals now categorized in roci runner and safe tools auto-accept; apply_patch emits diff updates and deletes move to ~/.homie/trash.
- 2026-02-09: Chat bootstrap loop fix in web: gate initial `chat.account.read/chat.list/chat.model.list/chat.skills.list` refresh to once per connected session and reset on disconnect/namespace change to prevent repeated request storms.
- 2026-02-09: Added `chat.tools.list` RPC + dynamic `openclaw_browser` tool provider scaffold (disabled by default), enabling config-driven discovery of tool availability in UI.
- 2026-02-09: Added env-gated live integration tests `src/core/tests/live_tools.rs` covering `ls`, `web_search`, and `web_fetch` against configured providers when `HOMIE_LIVE_TESTS=1`.
- 2026-02-10: Added mobile Expo scaffold at `src/apps/mobile` (SDK 54 tabs template) with chat-first tab shell, semantic theme tokens, reduced-motion-aware screen entrance animation, and runtime gateway URL config via `EXPO_PUBLIC_HOMIE_GATEWAY_URL`.
- 2026-02-10: Mobile chat now requires persisted gateway target setup (OOBE) before use; removed localhost fallback, added async-storage target edit/clear in Settings, and bound chat transport to saved target.
- 2026-02-10: Web shared-client cleanup completed for `remotely-8di.2.4`: split `use-gateway` into transport/rpc/subscription helpers, split `use-chat` with thread/composer/account helper modules, switched chat event reducer to shared `mapChatEvent`, migrated web protocol types to `@homie/shared`, and removed local `src/web/src/lib/protocol.ts`.
- 2026-02-10: Mobile chat now uses a left slide-in conversations drawer (header toggle + reduced-motion-aware animation), keeps chat detail always visible, and renders approval items inline with Accept/Decline actions wired through `ChatTimeline` callbacks.
- 2026-02-11: `chat.thread.read` (roci) now hydrates thread state before first include_turns read and falls back to `{thread:{id}} + settings` instead of `session_not_found` when hydration still yields no in-memory thread.
- 2026-02-11: Roci thread persistence now stores tool-call artifacts (`mcpToolCall` items) and reconstructs tool call/tool result model context during rehydrate; prevents post-restart loss of tool outputs and reduces repeated tool reruns.
- 2026-02-11: Mobile color token cleanup (`remotely-8di.10.1`) replaced hardcoded chat/shell rgba/hex literals in scoped files with `palette.overlay`, `surface0/1/2`, and tokenized white; left only shadow/boot-background literals with TODOs pending dedicated tokens.
- 2026-02-11: Mobile deprecated palette alias cleanup replaced `palette.surfaceAlt`/`palette.surface` usages in app/components with `surface1`/`surface0`; accent/status pill text now uses fixed `palettes.light.surface0` for legibility across light/dark modes.
- 2026-02-11: Mobile app shell refactor (`remotely-8di.10.2`) moved header/drawer into shared `AppShell`, switched PrimarySectionMenu to expo-router route navigation (`/(tabs)`, `/terminals`, `/settings`), and lifted gateway/chat state into `(tabs)` provider to preserve chat/terminal drawer actions across route screens.
- 2026-02-11: Chat timeline redesign stayed stable after splitting into focused modules (`ChatTimeline`, message item, state card, helpers, styles); keeping timeline file <500 LOC made follow-up UX and bug fixes materially easier.
- 2026-02-11: Mobile perf/a11y pass: converting chat/terminal drawer lists from ScrollView to FlatList with memoized rows + render-window tuning reduced render churn and improved scroll responsiveness while preserving long-press/thread actions.
- 2026-02-11: Mobile terminals now support live attach/stream/input/resize via terminal.session.attach/input/resize + WS binary frame decode in MobileTerminalPane; no xterm yet, plain text console with quick keys.
- 2026-02-11: Provider auth docs now explicitly define Homie device-code flow (`chat.account.login.start/poll`) and note that `gh auth login` does not populate `~/.homie/credentials` for `github-copilot`.
- 2026-02-11: Added dedicated provider auth runbook at docs/provider-auth.md and linked from docs/config.md for device-code login troubleshooting.
- 2026-02-11: Shared chat client now includes typed provider auth APIs (`chat.account.list`, `chat.account.login.start`, `chat.account.login.poll`); both web chat panel and mobile settings consume the same flow with device-code polling and live provider status refresh.
- 2026-02-11: Skill reference UX parity pass: web slash trigger now accepts hyphenated names (`/skill-creator`), `$skill-name` renders as inline skill chips in composer, and inline menu exposes listbox/option semantics for keyboard/screen-reader parity.
- 2026-02-11: Mobile chat composer now loads live `chat.skills.list` data and supports slash insertion (`/` -> tap suggestion -> `$skill `) with bounded, scrollable suggestion panel above the input.
- 2026-02-11: Web build breakages fixed: TerminalScreen session menu now receives required refs from App (trigger/menu/first item) with escape/outside-close handling; chat delta handler now assigns stable fallback assistant item IDs when provider omits itemId.
- 2026-02-12: Added `providers.openai_compatible` config support (`base_url`, optional `api_key`, optional `models` fallback) and wired `chat.model.list` to discover local OpenAI-compatible `/models`, so vLLM/local proxies can populate model pickers without requiring env exports.
