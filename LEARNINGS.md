# Learnings

- 2026-02-01: Initialized.
- 2026-02-01: Added backend PRD in prd.md from plan.md; co-located gateway+node, Tailscale auth, Codex integration, persistence.
- 2026-02-01: Added web PRD in web.prd; terminal-only web client, xterm.js, tabs/keybar, themes, saved targets.
- 2026-02-01: Added RN PRD in rn-mobile.prd; terminal-only, WebView xterm.js, tabs, target management.
- 2026-01-31: US-002 WS server: axum 0.8 + tokio-tungstenite. TailscaleWhois trait needs object-safe (Pin<Box<dyn Future>>) for Arc<dyn> in axum state. ConnectInfo requires into_make_service_with_connect_info; use middleware to inject RemoteIp extension. tokio::time::sleep_until in select! for idle timeout (not post-loop check). tokio-tungstenite 0.26 uses Utf8Bytes not String.
- 2026-01-31: US-003 Terminal service: portable-pty 0.9 returns anyhow::Error from MasterPty methods (resize, try_clone_reader) — map to String rather than pulling anyhow dep. Reader thread uses std::thread (blocking I/O) + AtomicBool shutdown flag + oneshot channel bridge. Output forwarding via mpsc → tokio task → WsMessage::Binary. TerminalService is per-connection (not shared), lives in message loop scope — Drop triggers shutdown_all. Reap interval (2s) polls try_wait for exit events.
- 2026-01-31: US-004 Router + subscriptions: ServiceHandler trait uses `Pin<Box<dyn Future + Send + '_>>` return for handle_request (can't use async_trait without the dep, and object-safety requires boxing). MessageRouter extracts namespace from first dotted segment of method name. SubscriptionManager uses three indexes (exact, prefix, catch-all) for O(1)-ish topic matching. Backpressure via try_send on bounded mpsc channel — drops PTY frames when client is slow rather than blocking. Events are only delivered to clients with matching subscriptions (no more broadcast). ServiceRegistry is Clone (shared via AppState) and advertises capabilities in ServerHello.
- 2026-01-31: US-005 Agent service (Codex integration): CodexProcess spawns `codex app-server` with stdin/stdout pipes, JSONL protocol. Reader loop uses tokio::select! to interleave pending-waiter registration with line reads. `method` param in handle_request must be cloned to String before moving into the async block (lifetime issue). Event forwarder maps Codex notification methods to Homie topics via static lookup. Approval requests from Codex carry an integer `id` — forwarded as `codex_request_id` in event params, client responds via `agent.chat.approval.respond` RPC. AgentService lazily spawns CodexProcess on first `agent.chat.create`. outbound_tx must be cloned before passing to both TerminalService and AgentService in connection.rs.
- 2026-01-31: US-006 Persistence layer: rusqlite 0.38 (bundled) for sqlite storage. `Store` trait (Send+Sync+'static) with `&self` methods — Mutex<Connection> for interior mutability. rusqlite doesn't impl ToSql/FromSql for u64 — cast to i64 at boundary. Clippy flags `from_str` method name as conflicting with std trait — renamed to `from_label`. Store passed as Arc<dyn Store> through AppState → run_connection → services. build_router calls mark_all_inactive on startup to flag stale sessions. Services persist metadata on create/exit/disconnect. New RPCs: `terminal.session.list`, `agent.chat.list`.
