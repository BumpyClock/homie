[PRD]
# PRD: Homie Backend (Gateway + Node, co-located)

## Overview
Single-host backend that exposes WebSocket APIs for terminal sessions and Agent.chat , Initially just `Codex-cli app server`. Gateway + Node run on the same machine, sharing an internal router while preserving protocol structure for future multi-node expansion.

## Goals
- Co-located backend service that serves clients over WS (loopback + Tailscale Serve)
- PTY session lifecycle with low-latency streaming
- Codex app-server integration with faithful event routing
- Persist chat/terminal metadata + event log pointer for resumability
- Protocol foundation usable by future web/mobile clients

## Quality Gates

These commands must pass for every user story:
- `cargo fmt --check` - Formatting
- `cargo clippy -- -D warnings` - Linting

For UI stories, also include:
- Verify in browser using dev-browser skill

## User Stories

### US-001: Define protocol envelope + handshake
**Description:** As a client, I want a stable handshake and message envelope so that I can communicate with the backend reliably.

**Acceptance Criteria:**
- [ ] Define versioned handshake fields (protocol min/max, client identity, auth fields)
- [ ] Define request/response/event envelope schema with `id`, `method`, `params`, `error`, `topic`
- [ ] Define binary frame header format for PTY bytes (includes `sessionId` + stream type)
- [ ] Encode/decode implemented in Rust types used by the backend

### US-002: WS server + auth (Tailscale identity)
**Description:** As a user, I want to connect to the backend over WS with Tailscale identity checks so that access is limited to my tailnet.

**Acceptance Criteria:**
- [ ] WS server listens on loopback; optional bind for tailnet or Serve
- [ ] When behind Tailscale Serve, validate identity headers via `tailscale whois`
- [ ] Reject connections without valid identity or incompatible protocol version
- [ ] Connection lifecycle includes heartbeat + idle timeout

### US-003: Terminal service (PTY sessions)
**Description:** As a user, I want to start and control terminal sessions so that I can run commands remotely.

**Acceptance Criteria:**
- [ ] Implement `terminal.session.start`, `attach`, `resize`, `input`, `kill`
- [ ] PTY runtime uses portable-pty (agent-term patterns)
- [ ] Stream PTY output as binary frames with `sessionId`
- [ ] Session cleanup on client disconnect and process exit

### US-004: Router + subscriptions
**Description:** As a client, I want multiplexed messaging so that I can subscribe to terminal output and Codex events over one WS.

**Acceptance Criteria:**
- [ ] Route requests by `service.method` to internal handlers
- [ ] Support `event` subscriptions with `topic` filtering
- [ ] Backpressure handling for high-volume PTY output
- [ ] Internal registry supports future multi-node expansion but runs local-only now

### US-005: Codex app-server integration
**Description:** As a user, I want Codex chat sessions routed through the backend so that I can chat from any client.

**Acceptance Criteria:**
- [ ] Spawn/manage `codex app-server` sessions (CodexMonitor reference)
- [ ] Implement `agent.chat.create`, `agent.chat.message.send`, `agent.chat.event.subscribe`, `agent.chat.cancel`
- [ ] Forward Codex events without altering semantics (delta/final/tool/status)
- [ ] When Codex requests approval, forward approval-required events to clients

### US-006: Persistence layer
**Description:** As a user, I want chat/session metadata stored so that sessions can be resumed after restart.

**Acceptance Criteria:**
- [ ] Persist chat metadata + append-only event log pointer
- [ ] Persist terminal session metadata (start time, cmd, status)
- [ ] On restart, list stored sessions as inactive until reattached
- [ ] Storage interface supports future backend migration

## Functional Requirements
- FR-1: Backend runs on a single host; gateway + node are co-located
- FR-2: WS API uses versioned handshake + envelope per US-001
- FR-3: Auth relies on Tailscale identity for MVP; app tokens deferred
- FR-4: Terminal methods and output streaming match US-003
- FR-5: Codex events are routed transparently to clients
- FR-6: Event subscriptions are per-connection with topic filters
- FR-7: Persistence stores chat + terminal metadata and event pointers

## Non-Goals
- Remote node management across multiple machines
- Public TLS deployment or cert pinning
- Token-based pairing/auth in MVP
- File transfer, clipboard, or job runner features
- Client UI implementation

## Technical Considerations
- Rust backend; reuse agent-term PTY runtime where possible
- Use tokio WS stack; binary frames for PTY output
- Consider sqlite for metadata/event pointer storage
- Keep internal router aligned with future gatewayâ†”node split

## Success Metrics
- Start a terminal session and receive output within 1s on local tailnet
- Codex chat message round-trip succeeds with streamed deltas
- Restart backend and list previous sessions as inactive

## Open Questions
- Single binary vs two processes on the same host?
- Multi-client attach to same PTY session in MVP?
- Event log retention policy (size/time)?
[/PRD]
